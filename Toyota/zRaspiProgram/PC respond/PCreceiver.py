import socket
import json

# *** ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‚ö†Ô∏è ***
# HOST ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á PC ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Pi)
# PORT ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô 'sender_address' ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á JSON ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô 1234)
# ---------------------------------------------------------------------------------

# üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á PC/Sender ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ñ‡πâ‡∏≤ PC ‡∏°‡∏µ IP 192.168.1.100 ‡πÅ‡∏•‡∏∞‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏≠ 1234
HOST = "0.0.0.0" 
PORT = 8001 
# ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á IP ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ '0.0.0.0' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã
# HOST = "0.0.0.0" 

def start_udp_listener():
    """‡πÄ‡∏õ‡∏¥‡∏î Socket UDP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Pi"""
    
    # ‡πÉ‡∏ä‡πâ SOCK_DGRAM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UDP
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    
    try:
        sock.bind((HOST, PORT))
        print("--------------------------------------------------")
        print(f"UDP Listener started. Listening on {HOST}:{PORT}")
        print("‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å Raspberry Pi...")
        print("--------------------------------------------------")
        
        while True:
            # ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1024 ‡πÑ‡∏ö‡∏ï‡πå)
            data, addr = sock.recvfrom(1024) 
            
            try:
                # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ö‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô JSON string ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Python dict
                json_str = data.decode("utf-8")
                response = json.loads(json_str)
                
                print(f"\n‚úÖ RECEIVED UDP RESPONSE from {addr[0]}:{addr[1]}")
                print("==============================================")
                print(json.dumps(response, indent=4))
                print("==============================================")
                
            except json.JSONDecodeError:
                print(f"\n[ERROR] Received invalid JSON from {addr}: {data.decode('utf-8')}")
                
    except KeyboardInterrupt:
        print("\n[INFO] UDP Listener stopped by user.")
    except Exception as e:
        print(f"\n[FATAL ERROR] Failed to bind or listen: {e}")
    finally:
        sock.close()

if __name__ == "__main__":
    start_udp_listener()