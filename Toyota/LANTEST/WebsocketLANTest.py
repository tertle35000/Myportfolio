import websocket
import json
import base64
import time
import socket
import struct
import sys
import ssl

# ==============================================================================
# ðŸ“º à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 1: à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² (à¸•à¹‰à¸­à¸‡à¹à¸à¹‰à¹„à¸‚à¸„à¹ˆà¸²à¹ƒà¸™à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰) ðŸ› ï¸
# ==============================================================================

# --- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¸§à¸µà¸‚à¸­à¸‡à¸„à¸¸à¸“ ---
TV_IP = "192.168.128.241"
TV_MAC_ADDRESS = "E8:AA:CB:49:51:84" 
APP_NAME = "MyRemoteControlApp"
# à¹‚à¸—à¹€à¸„à¹‡à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸ˆà¸²à¸à¸à¸²à¸£à¸ˆà¸±à¸šà¸„à¸¹à¹ˆ (Token Must be set!)
TOKEN = "63043679" 

# à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ª Base64 à¸‚à¸­à¸‡à¸Šà¸·à¹ˆà¸­à¹à¸­à¸›à¸žà¸¥à¸´à¹€à¸„à¸Šà¸±à¸™
ENCODED_NAME = base64.b64encode(APP_NAME.encode('utf-8')).decode('utf-8')

# --- URL à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ (à¹ƒà¸Šà¹‰ WSS à¹à¸¥à¸°à¸žà¸­à¸£à¹Œà¸• 8002 à¸žà¸£à¹‰à¸­à¸¡ Token) ---
if TOKEN:
    URL = f"wss://{TV_IP}:8002/api/v2/channels/samsung.remote.control?name={ENCODED_NAME}&token={TOKEN}"
else:
    # à¹‚à¸«à¸¡à¸”à¸ˆà¸±à¸šà¸„à¸¹à¹ˆ (Pairing) - à¹„à¸¡à¹ˆà¸„à¸§à¸£à¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™à¹à¸¥à¹‰à¸§
    URL = f"wss://{TV_IP}:8002/api/v2/channels/samsung.remote.control?name={ENCODED_NAME}"

# --- à¸„à¸³à¸ªà¸±à¹ˆà¸‡ WebSocket à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸ªà¹ˆà¸‡ ---
# à¹ƒà¸Šà¹‰ KEY_POWER à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸¥à¸±à¸šà¸ªà¸–à¸²à¸™à¸° (à¸›à¸´à¸”à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¸´à¸”, à¹€à¸›à¸´à¸”à¹€à¸¡à¸·à¹ˆà¸­à¸›à¸´à¸”/à¸ªà¹à¸•à¸™à¸”à¹Œà¸šà¸²à¸¢)
COMMAND_TO_SEND = {
    "method": "ms.remote.control",
    "params": {
        "Cmd": "Click",
        "DataOfCmd": "KEY_POWER",  
        "Option": "false", 
        "TypeOfRemote": "SendRemoteKey"
    }
}

# ==============================================================================
# ðŸŸ¢ à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 2: à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Wake-on-LAN (WoL) à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡
# ==============================================================================

def wake_on_lan(mac_address):
    """à¸ªà¹ˆà¸‡ Magic Packet à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¸—à¸µà¸§à¸µ Samsung"""
    mac_address = mac_address.replace(':', '').replace('-', '').replace('.', '').upper()
    if len(mac_address) != 12:
        raise ValueError("MAC Address à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ 12 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£")
    
    data = b'FFFF' + (mac_address * 16).encode()
    send_data = b''
    for i in range(0, len(data), 2):
        send_data += struct.pack('H', int(data[i: i + 2], 16))

    BROADCAST_IP = '255.255.255.255'
    PORT = 9

    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)
    sock.sendto(send_data, (BROADCAST_IP, PORT))
    print(f"âœ… WoL: à¸ªà¹ˆà¸‡ Magic Packet à¹„à¸›à¸¢à¸±à¸‡ {mac_address} à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹à¸¥à¹‰à¸§")

# ==============================================================================
# ðŸ”µ à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 3: à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ WebSocket (à¸„à¸§à¸šà¸„à¸¸à¸¡/à¸›à¸´à¸”)
# ==============================================================================

def on_message(ws, message):
    data = json.loads(message)

    # à¹€à¸£à¸²à¸„à¸²à¸”à¸«à¸§à¸±à¸‡ ms.channel.connect à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
    if data.get('event') == 'ms.channel.connect':
        # à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸—à¸±à¸™à¸—à¸µ
        time.sleep(0.5) 
        print(f"âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡ {COMMAND_TO_SEND['params']['DataOfCmd']}")
        try:
            ws.send(json.dumps(COMMAND_TO_SEND))
        except Exception as e:
            print(f"âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡: {e}")
            
        # à¸›à¸´à¸”à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡
        time.sleep(1)
        ws.close()

def on_error(ws, error):
    # à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸ªà¸”à¸‡ error à¹ƒà¸™ Workaround retry loop
    pass 

def on_close(ws, close_status_code, close_msg):
    # à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸ªà¸”à¸‡ close message à¹ƒà¸™ Workaround retry loop
    pass 

def on_open(ws):
    pass 


def control_tv_websocket(silent=False):
    """à¸£à¸±à¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WebSocket à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸„à¸§à¸šà¸„à¸¸à¸¡"""
    if not silent:
        print(f"à¸žà¸¢à¸²à¸¢à¸²à¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š: {URL}")

    ws = websocket.WebSocketApp(
        URL,
        on_open=on_open,
        on_message=on_message,
        on_error=on_error,
        on_close=on_close
    )

    # à¸£à¸±à¸™à¹‚à¸„à¹‰à¸”à¸žà¸£à¹‰à¸­à¸¡à¸ˆà¸±à¸”à¸à¸²à¸£ SSL à¸ªà¸³à¸«à¸£à¸±à¸š WSS
    # à¸•à¹‰à¸­à¸‡à¸¡à¸µ return value à¹€à¸žà¸·à¹ˆà¸­à¸šà¸­à¸à¸ªà¸–à¸²à¸™à¸°
    try:
        ws.run_forever(sslopt={"cert_reqs": ssl.CERT_NONE}, ping_interval=5, ping_timeout=2) 
        return True # à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
    except Exception as e:
        if not silent:
            print(f"âŒ à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WebSocket à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: {e}")
        # à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ Timeout/Connection Refused à¹ƒà¸«à¹‰à¸–à¸·à¸­à¸§à¹ˆà¸²à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§
        if "10060" in str(e) or "refused" in str(e).lower():
            return False 
        else:
            raise e # à¸ªà¹ˆà¸‡ Exception à¸­à¸·à¹ˆà¸™à¹† à¸•à¹ˆà¸­à¹„à¸›

# ==============================================================================
# ðŸš€ à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 4: à¸à¸²à¸£à¸£à¸±à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸«à¸¥à¸±à¸ (Main Execution)
# ==============================================================================

def wake_and_confirm():
    """Workaround: à¸ªà¸±à¹ˆà¸‡ WoL à¹à¸¥à¸°à¸žà¸¢à¸²à¸¢à¸²à¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸‹à¹‰à¸³à¹€à¸žà¸·à¹ˆà¸­à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¹€à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡"""
    
    # 1. à¸ªà¹ˆà¸‡ WoL Magic Packet
    try:
        wake_on_lan(TV_MAC_ADDRESS)
    except Exception as e:
        print(f"âŒ WoL à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: {e}")
        return

    print("\nðŸ’¡ WoL à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§ à¸à¸³à¸¥à¸±à¸‡à¸£à¸­à¸—à¸µà¸§à¸µà¸šà¸¹à¸• (30 à¸§à¸´à¸™à¸²à¸—à¸µ)...")
    time.sleep(30) # à¸£à¸­à¸™à¸²à¸™à¸žà¸­à¹ƒà¸«à¹‰à¸—à¸µà¸§à¸µà¹€à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡
    
    # 2. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸°/à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡ KEY_POWER à¸‹à¹‰à¸³à¸”à¹‰à¸§à¸¢ WebSocket
    MAX_ATTEMPTS = 3
    for attempt in range(MAX_ATTEMPT):
        print(f"à¸žà¸¢à¸²à¸¢à¸²à¸¡à¸¢à¸·à¸™à¸¢à¸±à¸™à¸ªà¸–à¸²à¸™à¸°/à¸ªà¹ˆà¸‡ KEY_POWER (à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ {attempt+1}/{MAX_ATTEMPTS})...")
        
        # à¸£à¸±à¸™à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¸§à¸šà¸„à¸¸à¸¡ WebSocket à¸‚à¸­à¸‡à¸„à¸¸à¸“à¹ƒà¸™à¹‚à¸«à¸¡à¸” Silent
        if control_tv_websocket(silent=True):
            print("âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! à¸—à¸µà¸§à¸µà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§")
            return
        else:
            print("âŒ à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ (Timeout/Refused) à¸à¸³à¸¥à¸±à¸‡à¸¥à¸­à¸‡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡...")
            time.sleep(5)
            
    print(f"\nâš ï¸ à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§à¹ƒà¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸ {MAX_ATTEMPTS} à¸„à¸£à¸±à¹‰à¸‡: à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸°à¸—à¸µà¸§à¸µà¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡")


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1].lower() == 'on':
        # à¸£à¸±à¸™à¹‚à¸«à¸¡à¸”à¹€à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ (WoL + Workaround)
        wake_and_confirm()
    else:
        # à¸£à¸±à¸™à¹‚à¸«à¸¡à¸”à¸„à¸§à¸šà¸„à¸¸à¸¡/à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ (WebSocket à¸˜à¸£à¸£à¸¡à¸”à¸²)
        control_tv_websocket()